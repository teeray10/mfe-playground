{"version":3,"file":"dynamic-federation.js","sourceRoot":"","sources":["../../../../../../libs/mf-runtime/src/lib/loader/dynamic-federation.ts"],"names":[],"mappings":"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","sourcesContent":["type Scope = unknown;\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\ntype Factory = () => any;\r\n\r\ntype Container = {\r\n    init(shareScope: Scope): void;\r\n    get(module: string): Factory;\r\n};\r\n\r\ndeclare const __webpack_init_sharing__: (shareScope: string) => Promise<void>;\r\ndeclare const __webpack_share_scopes__: { default: Scope };\r\n\r\ntype ContainerMap = { [key: string]: Container };\r\n\r\nconst containerMap: ContainerMap = {};\r\nconst remoteMap = {}\r\n\r\nlet isDefaultScopeInitialized = false;\r\n\r\nasync function lookupExposedModule<T>(key: string, exposedModule: string): Promise<T> {\r\n      const container = containerMap[key];\r\n      const factory = await container.get(exposedModule);\r\n      const Module = factory();\r\n      return Module as T;\r\n}\r\n\r\nasync function initRemote(container: Container, key:string) {\r\n    // const container = window[key] as Container;\r\n\r\n    // Do we still need to initialize the remote?\r\n    if (remoteMap[key]) {\r\n        return container;\r\n    }\r\n\r\n    // Do we still need to initialize the share scope?\r\n    if (!isDefaultScopeInitialized) { \r\n        await __webpack_init_sharing__('default');\r\n        isDefaultScopeInitialized = true;\r\n    }\r\n\r\n    await container.init(__webpack_share_scopes__.default);\r\n    remoteMap[key] = true;\r\n    return container;\r\n}\r\n\r\nexport type LoadRemoteEntryOptions = LoadRemoteEntryScriptOptions | LoadRemoteEntryEsmOptions;\r\n\r\nexport type LoadRemoteEntryScriptOptions = {\r\n    type?: 'script';\r\n    remoteEntry: string;\r\n    remoteName: string;\r\n}\r\n\r\nexport type LoadRemoteEntryEsmOptions = {\r\n    type: 'module';\r\n    remoteEntry: string;\r\n}\r\n\r\nexport async function loadRemoteEntry(remoteEntry: string, remoteName: string): Promise<void>;\r\nexport async function loadRemoteEntry(options: LoadRemoteEntryOptions): Promise<void>;\r\nexport async function loadRemoteEntry(remoteEntryOrOptions: string | LoadRemoteEntryOptions, remoteName?: string): Promise<void> {\r\n    if (typeof remoteEntryOrOptions === 'string') {\r\n        const remoteEntry = remoteEntryOrOptions;\r\n        return await loadRemoteScriptEntry(remoteEntry, remoteName);\r\n    }\r\n    else if (remoteEntryOrOptions.type === 'script') {\r\n        const options = remoteEntryOrOptions;\r\n        return await loadRemoteScriptEntry(options.remoteEntry, options.remoteName);\r\n    }\r\n    else if (remoteEntryOrOptions.type === 'module') {\r\n        const options = remoteEntryOrOptions;\r\n        await loadRemoteModuleEntry(options.remoteEntry);\r\n    }\r\n}\r\n\r\nasync function loadRemoteModuleEntry(remoteEntry: string): Promise<void> {\r\n    if (containerMap[remoteEntry]) {\r\n        return Promise.resolve();\r\n    }\r\n    return await import(/* webpackIgnore:true */remoteEntry).then(container => { \r\n        initRemote(container, remoteEntry); \r\n        containerMap[remoteEntry] = container;\r\n    });\r\n}\r\n\r\nasync function loadRemoteScriptEntry(remoteEntry: string, remoteName: string): Promise<void> {\r\n    return new Promise<void>((resolve, reject) => {\r\n\r\n        // Is remoteEntry already loaded?\r\n        if (containerMap[remoteName]) {\r\n            resolve();\r\n            return;\r\n        }\r\n\r\n        const script = document.createElement('script');\r\n        script.src = remoteEntry;\r\n\r\n        script.onerror = reject;\r\n\r\n        script.onload = () => {\r\n            const container = window[remoteName] as Container;\r\n            initRemote(container, remoteName);\r\n            containerMap[remoteName] = container;\r\n            resolve(); \r\n        }\r\n\r\n        document.body.appendChild(script);\r\n    });\r\n}\r\n\r\nexport type LoadRemoteModuleOptions = LoadRemoteModuleScriptOptions | LoadRemoteModuleEsmOptions;\r\n\r\nexport type LoadRemoteModuleScriptOptions = { \r\n    type?: 'script';\r\n    remoteEntry?: string; \r\n    remoteName: string; \r\n    exposedModule: string;\r\n} \r\n\r\nexport type LoadRemoteModuleEsmOptions = { \r\n    type: 'module';\r\n    remoteEntry: string; \r\n    exposedModule: string;\r\n} \r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport async function loadRemoteModule<T = any>(options: LoadRemoteModuleOptions): Promise<T> {\r\n\r\n    let loadRemoteEntryOptions: LoadRemoteEntryOptions;\r\n    let key: string;\r\n\r\n    // To support legacy API (< ng 13)\r\n    if (!options.type) {\r\n        options.type = 'script';\r\n    }\r\n\r\n    if (options.type === 'script') {\r\n        loadRemoteEntryOptions = {\r\n            type: 'script',\r\n            remoteEntry: options.remoteEntry,\r\n            remoteName: options.remoteName\r\n        };\r\n        key = options.remoteName;\r\n    }\r\n    else if (options.type === 'module') {\r\n        loadRemoteEntryOptions = {\r\n            type: 'module',\r\n            remoteEntry: options.remoteEntry,\r\n        };\r\n        key = options.remoteEntry;\r\n    }\r\n\r\n    if (options.remoteEntry) {\r\n        await loadRemoteEntry(loadRemoteEntryOptions);\r\n    }\r\n\r\n    return await lookupExposedModule<T>(key, options.exposedModule);\r\n}\r\n"]}